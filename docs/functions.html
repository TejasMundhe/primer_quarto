<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.0.37">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>Preceptor’s Primer for Bayesian Data Science - Functions</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./animation.html" rel="next">
<link href="./tools.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
</head>
<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }"><div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title">Functions</h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Preceptor’s Primer for Bayesian Data Science</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/PPBDS/primer/" title="Source Code" class="sidebar-tool px-1"><i class="bi bi-github"></i></a>
    <a href="" title="Download" id="sidebar-tool-dropdown-0" class="sidebar-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi bi-download"></i></a>
    <ul class="dropdown-menu" aria-labelledby="sidebar-tool-dropdown-0">
<li>
          <a class="dropdown-item sidebar-tools-main-item" href="./Preceptor-s-Primer-for-Bayesian-Data-Science.pdf">
            <i class="bi bi-bi-file-pdf pe-1"></i>
          Download PDF
          </a>
        </li>
        <li>
          <a class="dropdown-item sidebar-tools-main-item" href="./Preceptor-s-Primer-for-Bayesian-Data-Science.epub">
            <i class="bi bi-bi-journal pe-1"></i>
          Download ePub
          </a>
        </li>
    </ul>
</div>
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">Welcome</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./preamble.html" class="sidebar-item-text sidebar-link">Preamble</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./00-getting-started.html" class="sidebar-item-text sidebar-link">Getting Started</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-visualization.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Visualization</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-wrangling.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Wrangling</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-data.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Data</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04-rubin-causal-model.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Rubin Causal Model</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05-probability.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Probability</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06-one-parameter.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">One Parameter</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07-two-parameters.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Two Parameters</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08-three-parameters.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Three Parameters</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./09-four-parameters.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Four Parameters</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10-five-parameters.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Five Parameters</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./11-n-parameters.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">N Parameters</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./12-case-studies.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Case Studies</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./tools.html" class="sidebar-item-text sidebar-link">Tools</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./functions.html" class="sidebar-item-text sidebar-link active">Functions</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./animation.html" class="sidebar-item-text sidebar-link">Animation</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./set-up.html" class="sidebar-item-text sidebar-link">Set Up for Working on The Primer</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">References</a>
  </div>
</li>
    </ul>
</div>
</nav><!-- margin-sidebar --><div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#list-columns-and-map-functions" id="toc-list-columns-and-map-functions" class="nav-link" data-scroll-target="#list-columns-and-map-functions">List-columns and map functions</a></li>
  <li>
<a href="#custom-functions" id="toc-custom-functions" class="nav-link" data-scroll-target="#custom-functions">Custom Functions</a>
  <ul class="collapse">
<li><a href="#creating-your-own-functions" id="toc-creating-your-own-functions" class="nav-link" data-scroll-target="#creating-your-own-functions">Creating your own functions</a></li>
  <li><a href="#anonymous-functions-with-map_-functions" id="toc-anonymous-functions-with-map_-functions" class="nav-link" data-scroll-target="#anonymous-functions-with-map_-functions">Anonymous functions with <code>map_*</code> functions</a></li>
  <li><a href="#skateboard-perfectly-formed-rear-view-mirror" id="toc-skateboard-perfectly-formed-rear-view-mirror" class="nav-link" data-scroll-target="#skateboard-perfectly-formed-rear-view-mirror">Skateboard &gt;&gt; perfectly formed rear-view mirror</a></li>
  </ul>
</li>
  <li><a href="#no_na_sampler" id="toc-no_na_sampler" class="nav-link" data-scroll-target="#no_na_sampler"><code>no_NA_sampler()</code></a></li>
  <li><a href="#prediction-game" id="toc-prediction-game" class="nav-link" data-scroll-target="#prediction-game">Prediction Game</a></li>
  <li>
<a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary">Summary</a>
  <ul class="collapse">
<li><a href="#lists-and-list-columns" id="toc-lists-and-list-columns" class="nav-link" data-scroll-target="#lists-and-list-columns">Lists and list-columns</a></li>
  <li><a href="#writing-functions" id="toc-writing-functions" class="nav-link" data-scroll-target="#writing-functions">Writing functions</a></li>
  <li><a href="#distributions" id="toc-distributions" class="nav-link" data-scroll-target="#distributions">Distributions</a></li>
  </ul>
</li>
  </ul><div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/PPBDS/primer/edit/main/functions.qmd" class="toc-action">Edit this page</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<h1 class="title d-none d-lg-block">Functions</h1>
</div>



<div class="quarto-title-meta">

    
    
  </div>
  

</header><!-- Get rid of nhanes example as too confusing? --><!-- Get rid of anonymous function section as too confusing? Or save it for final section of Advanced stuff? --><!-- The functions created here should be more tightly connected to the functions created in the tutorial. Recall that we will be merging the tutorial into the chapter this summer, I hope! --><!-- And we also want to lay the groundwork for the problem set (and exam) which require writing a function. And, finally, all these exercises should be teaching something which is then referenced in probability and in stan_glm. Yet it is not clear what those would be. Maybe some simulations? --><!-- If the Democrats have a 50% chance of winning each seat in the Senate, what are the odds of them getting 60 seats (to beat the filibuster) at any one time? How much does their advantage have to be to have a 20% chance of getting 60? Do this first while pretending that all senates run each two years. Then do it staggered. Or is all that too complex? --><!-- Maybe an advanced form of the guessing game in which we are allowed to provide a function. The goal of inference is to come up with a function which wins the prediction game. --><!-- This is currently in problem set #3: Change the objective function. The simplest form of the Guessing Game just counts each contest separately. A more advanced for would give you a penalty which varies depending on how wrong you are. (This, obviously, is one way to think about minimizing the squared residuals.) This is very fun because there are many different penalty functions, each of which may lead to a different function winning the Guessing Game. --><!-- Another form of the Guessing Game is like a casino. One person (the Casino) gives a 50% confidence interval. The other person gets to pick either inside or outside. Then there is a draw. The Casino wins if the second person can't consistently win. --><section id="introduction" class="level2"><h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>A function is a piece of code that is packaged in a way that makes it easy to reuse. Functions make it easy for you to <code><a href="https://dplyr.tidyverse.org/reference/filter.html">filter()</a></code>, <code><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange()</a></code>, <code><a href="https://dplyr.tidyverse.org/reference/select.html">select()</a></code>, and create a <code><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble()</a></code>, as you have seen in Chapters @ref(visualization) and @ref(wrangling). Functions also allow you to transform variables and perform mathematical calculations. We use functions like <code><a href="https://rdrr.io/r/stats/Normal.html">rnorm()</a></code> and <code><a href="https://rdrr.io/r/stats/Uniform.html">runif()</a></code> to generate random draws from a distribution.</p>
<p>Every time we reference a function in this <em>Primer</em>, we include the parentheses. You call a function by including its parentheses and any necessary arguments within those parentheses. This is a correct call of <code><a href="https://rdrr.io/r/stats/Normal.html">rnorm()</a></code>:</p>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -1.263119</code></pre>
</div>
</div>
<p>If you run the function name without its parentheses, R will return the code that makes up the function.</p>
<div class="cell">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">rnorm</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>function (n, mean = 0, sd = 1) 
.Call(C_rnorm, n, mean, sd)
&lt;bytecode: 0x000001e1efbc01c0&gt;
&lt;environment: namespace:stats&gt;</code></pre>
</div>
</div>
<p>Functions can do all sorts of things. <code><a href="https://rdrr.io/r/base/sample.html">sample()</a></code> takes a vector of values and returns a number of values randomly selected from that vector. You can specify the number of random values with the argument <code>size</code>. This call is the equivalent of rolling a die.</p>
<div class="cell">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">6</span>, size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 6</code></pre>
</div>
</div>
<p>Functions can also take in other functions as arguments. For example, <code><a href="https://rdrr.io/r/base/lapply.html">replicate()</a></code> takes an expression and repeats it <code>n</code> times. What if we replicated the rolling of a die ten times?</p>
<div class="cell">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">replicate</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">6</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] 1 6 2 5 6 3 1 6 1 5</code></pre>
</div>
</div>
<p>An especially useful type of function is the family of <code>map_*</code> functions, from the <strong>purrr</strong> package, which is automatically loaded with <code><a href="https://tidyverse.tidyverse.org">library(tidyverse)</a></code>. These functions apply some other function to every row in a tibble.</p>
<div class="cell">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s create a tibble with one variable <code>x</code> which takes on three values: 3, 7, and 2.</p>
<div class="cell">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">16</span>, <span class="fl">9</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 1
      x
  &lt;dbl&gt;
1     4
2    16
3     9</code></pre>
</div>
</div>
<p>It is easy to use mutate to create a new variable, <code>sq_root</code>, which is the square root of each value of x.</p>
<div class="cell">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">16</span>, <span class="fl">9</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>sq_root <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 2
      x sq_root
  &lt;dbl&gt;   &lt;dbl&gt;
1     4       2
2    16       4
3     9       3</code></pre>
</div>
</div>
<p><code>map_*</code> functions provide another approach. A <code>map_*</code> function takes two required arguments. First is the object over which you want to iterate. This will generally be a column in the tibble in which you are working. Second is the function which you want to run for each row in the tibble.</p>
<div class="cell">
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">16</span>, <span class="fl">9</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>sq_root <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl</a></span><span class="op">(</span><span class="va">x</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 2
      x sq_root
  &lt;dbl&gt;   &lt;dbl&gt;
1     4       2
2    16       4
3     9       3</code></pre>
</div>
</div>
<p><code><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl()</a></code> (pronounced “map-double”) took the function <code><a href="https://rdrr.io/r/base/MathFun.html">sqrt()</a></code> and applied it to each element of <code>x</code>. There are two tricky parts to the use of map_* functions. First, you need to put the tilde symbol — the “~” — before the name of the function which you want to call. Without the <code>~</code>, you will get an error:</p>
<div class="cell">
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">16</span>, <span class="fl">9</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>sq_root <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl</a></span><span class="op">(</span><span class="va">x</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in `mutate()`:
! Problem while computing `sq_root = map_dbl(x, sqrt(.))`.
Caused by error in `as_mapper()`:
! object '.' not found</code></pre>
</div>
</div>
<p>Second, you need to include a period — the “.” — in the spot where the variable goes. Using the name of the variable — <code>x</code> in this case — will generate an error.</p>
<div class="cell">
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">16</span>, <span class="fl">9</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>sq_root <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl</a></span><span class="op">(</span><span class="va">x</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in `mutate()`:
! Problem while computing `sq_root = map_dbl(x, ~sqrt(x))`.
Caused by error in `stop_bad_type()`:
! Result 1 must be a single double, not a double vector of length 3</code></pre>
</div>
</div>
<p><em>Tilde and dot (<code>~</code> and <code>.</code>) are easy to forget.</em></p>
<p>If you know the expected output of your function, you can specify that kind of vector:</p>
<ul>
<li>
<code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code>: list<br>
</li>
<li>
<code><a href="https://purrr.tidyverse.org/reference/map.html">map_lgl()</a></code>: logical</li>
<li>
<code><a href="https://purrr.tidyverse.org/reference/map.html">map_int()</a></code>: integer</li>
<li>
<code><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl()</a></code>: double (numeric)</li>
<li>
<code><a href="https://purrr.tidyverse.org/reference/map.html">map_chr()</a></code>: character</li>
<li>
<code><a href="https://purrr.tidyverse.org/reference/map.html">map_df()</a></code>: data frame</li>
</ul>
<p>Since our example returns numeric output, we use <code><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl()</a></code> instead of <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code>.</p>
<p>The key difference between using <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code> and <code>map_*</code> functions is that <code>map_*</code> functions are designed to work well with lists, both as inputs and as outputs. <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code> is designed for atomic vectors, meaning vectors in which element is a single value.</p>
</section><section id="list-columns-and-map-functions" class="level2"><h2 class="anchored" data-anchor-id="list-columns-and-map-functions">List-columns and map functions</h2>
<p>Recall that a list is different from an atomic vector. In atomic vectors, each element of the vector has one value. Lists, however, can contain vectors, and even more complex objects, as elements.</p>
<div class="cell">
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">16</span>, <span class="fl">9</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"A"</span>, <span class="st">"Z"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">x</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
[1]  4 16  9

[[2]]
[1] "A" "Z"</code></pre>
</div>
</div>
<p><code>x</code> is a list with two elements. That element is a numeric vector of length 3. The second element is a character vector of length 2. We use <code>[[]]</code> to extract specific elements. Example:</p>
<div class="cell">
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">x</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 9</code></pre>
</div>
</div>
<p>The first <code>[[]]</code> extracts the first element form the list <code>x</code>. The second `[[]]`` extracts the 3rd element from the vector which is that first element.</p>
<p>There are a number of built-in R functions that output lists. For example, the <strong><em>ggplot</em></strong> objects you have been making store all of the plot information in lists. Any function that returns multiple values can be used to create a list output by wrapping that returned object with <code><a href="https://rdrr.io/r/base/list.html">list()</a></code>.</p>
<div class="cell">
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># range() returns the min and max of the argument </span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/range.html">range</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -2.189389  1.578740</code></pre>
</div>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>col_1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/range.html">range</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 1
  col_1    
  &lt;list&gt;   
1 &lt;dbl [2]&gt;</code></pre>
</div>
</div>
<p>Notice this is a 1x1 tibble with one observation, which is a list of one element. Voila! You have just created a <strong>list-column</strong>.</p>
<p><em>If a function returns multiple values as a vector, like <code><a href="https://rdrr.io/r/base/range.html">range()</a></code> does, you must use <code><a href="https://rdrr.io/r/base/list.html">list()</a></code> as a wrapper if you want to create a list-column.</em></p>
<p>A list column is a column of your data which is a <a href="https://adv-r.hadley.nz/vectors-chap.html#lists">list</a> rather than an atomic vector. Like with lists, you can pipe to <code><a href="https://rdrr.io/r/utils/str.html">str()</a></code> to examine the column.</p>
<div class="cell">
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>col_1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/range.html">range</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>tibble [1 × 1] (S3: tbl_df/tbl/data.frame)
 $ col_1:List of 1
  ..$ : num [1:2] -2.19 1.58</code></pre>
</div>
</div>
<p>We can use <code>map_*</code> functions to both create a list-column and then, much more importantly, work with that list-column afterwards. Example:</p>
<!-- DK: This is a good example. Needs to go slower, or be repeated several times. -->
<div class="cell">
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># This simple example demonstrates the workflow which we will often follow.</span></span>
<span><span class="co"># Start by creating a tibble which will be used to store the results. (Or start</span></span>
<span><span class="co"># with a tibble which already exists and to which you will be adding more</span></span>
<span><span class="co"># columns.) It is often convenient to get all the code working with just a few</span></span>
<span><span class="co"># rows. Once it is working, we increase the number of rows to a thousand or</span></span>
<span><span class="co"># million or whatever we need.</span></span>
<span></span>
<span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>ID <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  </span>
<span>  <span class="co"># The big convenience is being able to store a list in each row of the tibble.</span></span>
<span>  <span class="co"># Note that we are not using the value of ID in the call to rnorm(). (That is</span></span>
<span>  <span class="co"># why we don't have a "." anywhere.) But we are still using ID as a way of</span></span>
<span>  <span class="co"># iterating through each row; ID is keeping count for us, in a sense.</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>draws <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="va">ID</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  </span>
<span>  <span class="co"># Each succeeding step of the pipe works with columns already in the tibble</span></span>
<span>  <span class="co"># while, in general, adding more columns. The next step calculates the max</span></span>
<span>  <span class="co"># value in each of the draw vectors. We use map_dbl() because we know that</span></span>
<span>  <span class="co"># max() will returns a single number.</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>max <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl</a></span><span class="op">(</span><span class="va">draws</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  </span>
<span>  <span class="co"># We will often need to calculate more than one item from a given column like</span></span>
<span>  <span class="co"># draws. For example, in addition to knowing the max value, we would like to</span></span>
<span>  <span class="co"># know the range. Because the range is a vector, we need to store the result</span></span>
<span>  <span class="co"># in a list column. map() does that for us automatically.</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>min_max <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="va">draws</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/range.html">range</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 4
     ID draws        max min_max  
  &lt;int&gt; &lt;list&gt;     &lt;dbl&gt; &lt;list&gt;   
1     1 &lt;dbl [10]&gt; 1.12  &lt;dbl [2]&gt;
2     2 &lt;dbl [10]&gt; 0.757 &lt;dbl [2]&gt;
3     3 &lt;dbl [10]&gt; 1.64  &lt;dbl [2]&gt;</code></pre>
</div>
</div>
<p>This flexibility is only possible via the use of list-columns and <code>map_*</code> functions. This workflow is extremely common. We start with an empty tibble, using ID to specify the number of rows. With that skeleton, each step of the pipe adds a new column, working off a column which already exists.</p>
<!-- DK: Is this a good example? A good transition? Whole thing should go slower, with more examples. Need to be redone along with a redo of Functions A tutorial. -->
<p>Let’s practice with the <code>nhanes</code> dataset from the <strong>primer.data</strong> package. How could we add a column to the dataset that included the quantiles of the <code>height</code> variable for each <code>gender</code>?</p>
<div class="cell">
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">primer.data</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Select the relevant variables, and group by <code>gender</code>. We are grouping because we are curious as to how <code>height</code> is distributed in between <code>gender</code>. We drop any rows with missing data.</p>
<div class="cell">
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">nhanes</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">gender</span>, <span class="va">height</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/drop_na.html">drop_na</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">gender</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9,647 × 2
# Groups:   gender [2]
   gender height
   &lt;chr&gt;   &lt;dbl&gt;
 1 Male     165.
 2 Male     165.
 3 Male     165.
 4 Male     105.
 5 Female   168.
 6 Male     133.
 7 Male     131.
 8 Female   167.
 9 Female   167.
10 Female   167.
# … with 9,637 more rows
# ℹ Use `print(n = ...)` to see more rows</code></pre>
</div>
</div>
<p>There are two approaches. In the first, we are happy to have an output tibble with just two rows:</p>
<div class="cell">
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">nhanes</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">gender</span>, <span class="va">height</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/drop_na.html">drop_na</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">gender</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>q_height <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">height</span><span class="op">)</span><span class="op">)</span>,</span>
<span>            .groups <span class="op">=</span> <span class="st">"drop"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 2
  gender q_height 
  &lt;chr&gt;  &lt;list&gt;   
1 Female &lt;dbl [5]&gt;
2 Male   &lt;dbl [5]&gt;</code></pre>
</div>
</div>
<p>Note that there was no need to use <code>map_*</code> functions in this case. The simple <strong>dplyr</strong> approach works fine. The only “trick” is the use of <code><a href="https://rdrr.io/r/base/list.html">list()</a></code> to wrap the output of <code><a href="https://rdrr.io/r/stats/quantile.html">quantile()</a></code>. Use <code><a href="https://rdrr.io/r/utils/str.html">str()</a></code> to examine the exact values.</p>
<div class="cell">
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">nhanes</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">gender</span>, <span class="va">height</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/drop_na.html">drop_na</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">gender</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>q_height <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">height</span><span class="op">)</span><span class="op">)</span>,</span>
<span>            .groups <span class="op">=</span> <span class="st">"drop"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>tibble [2 × 2] (S3: tbl_df/tbl/data.frame)
 $ gender  : chr [1:2] "Female" "Male"
 $ q_height:List of 2
  ..$ : Named num [1:5] 83.8 154.3 160.6 165.9 184.5
  .. ..- attr(*, "names")= chr [1:5] "0%" "25%" "50%" "75%" ...
  ..$ : Named num [1:5] 83.6 166.2 173.8 179.4 200.4
  .. ..- attr(*, "names")= chr [1:5] "0%" "25%" "50%" "75%" ...</code></pre>
</div>
</div>
<p>Men are taller than women throughout the distribution, but the smallest individual (child) in the data, see the 0% quantile, happens to be male.</p>
<p>The second case involves a scenario in which we do not want to “lose” any rows in our tibble. We want a <code>q_height</code> column for all the rows, even if the values included are repetitive. A common scenario is that we want to use <code>q_height</code> to perform a calculation for each individual. To do this, we need a <code>map_*</code> function.</p>
<div class="cell">
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">nhanes</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">gender</span>, <span class="va">height</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/drop_na.html">drop_na</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">gender</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>q_height <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="va">height</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span>,</span>
<span>            .groups <span class="op">=</span> <span class="st">"drop"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9,647 × 2
   gender q_height 
   &lt;chr&gt;  &lt;list&gt;   
 1 Female &lt;dbl [5]&gt;
 2 Female &lt;dbl [5]&gt;
 3 Female &lt;dbl [5]&gt;
 4 Female &lt;dbl [5]&gt;
 5 Female &lt;dbl [5]&gt;
 6 Female &lt;dbl [5]&gt;
 7 Female &lt;dbl [5]&gt;
 8 Female &lt;dbl [5]&gt;
 9 Female &lt;dbl [5]&gt;
10 Female &lt;dbl [5]&gt;
# … with 9,637 more rows
# ℹ Use `print(n = ...)` to see more rows</code></pre>
</div>
</div>
<p>The first four lines of the pipe are the same in both cases. The only difference is the use of <code>list(quantile(height))</code> in the first and <code>map(height, ~ quantile(.)</code> in the second.</p>
<p>Until now, we have practiced using <code>map_*</code> functions with built-in R functions. Sometimes, however, there is not an R function which does what we want. When that happens, we need to create our own function.</p>
</section><section id="custom-functions" class="level2"><h2 class="anchored" data-anchor-id="custom-functions">Custom Functions</h2>
<p>There are many built-in functions in R. A function is composed of a name, a list of arguments and a body. We create our own functions with the <code>function()</code> function.</p>
<section id="creating-your-own-functions" class="level3"><h3 class="anchored" data-anchor-id="creating-your-own-functions">Creating your own functions</h3>
<p>Assume we want to create a function which adds 1 and 1 together. The first step is to write some R code which does that.</p>
<div class="cell">
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fl">1</span> <span class="op">+</span> <span class="fl">1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2</code></pre>
</div>
</div>
<p>This code will become the “body” of the function, the part in between the curly braces. We also need to a function definition, which is composed of the name of the function, a call to the <code>function()</code> function, and a pair of curly braces.</p>
<div class="cell">
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">add_one_and_one</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span><span class="op">{</span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Combining the function definition and the body of the function completes the process.</p>
<div class="cell">
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">add_one_and_one</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fl">1</span> <span class="op">+</span> <span class="fl">1</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">add_one_and_one</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2</code></pre>
</div>
</div>
<p>You just created a function! This function will return <code>1 + 1</code> whenever called.</p>
<p>Consider a function which adds the number 6 to a value <code>x</code>, a value which we want to allow the user provide.</p>
<div class="cell">
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">add_six_to_something</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">x</span> <span class="op">+</span> <span class="fl">6</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">add_six_to_something</span><span class="op">(</span>x <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 7</code></pre>
</div>
</div>
<p>You have incorporated your first <strong>formal argument</strong>. Formal arguments in functions are additional parameters that allow the user to customize the use of the function. Instead of adding <code>1 + 1</code> over and over again, your function takes in a number <code>x</code> that the user defines and adds 6. Consider a function with <em>two</em> formal arguments.</p>
<div class="cell">
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">add_x_to_y</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">x</span> <span class="op">+</span> <span class="va">y</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">add_x_to_y</span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3</code></pre>
</div>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">add_x_to_y</span><span class="op">(</span><span class="fl">4</span>, <span class="fl">3</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 7</code></pre>
</div>
</div>
</section><section id="anonymous-functions-with-map_-functions" class="level3"><h3 class="anchored" data-anchor-id="anonymous-functions-with-map_-functions">Anonymous functions with <code>map_*</code> functions</h3>
<p>We can create functions that perform operations “on the fly,” without bothering to give them a name. These nameless functions are called <a href="https://coolbutuseless.github.io/2019/03/13/anonymous-functions-in-r-part-1/">anonymous functions.</a></p>
<p>You can use anonymous functions in conjunction with the <code>map_*</code> family of functions. This is probably the most common use of anonymous functions, at least in this <em>Primer</em>.</p>
<p>You can call an anonymous function using a <code>~</code> operator and then using a <code>.</code> to represent the current element. Consider these three approaches:</p>
<div class="cell">
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>old <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">16</span>, <span class="fl">9</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>new_1 <span class="op">=</span> <span class="va">old</span> <span class="op">+</span> <span class="fl">6</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>new_2 <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl</a></span><span class="op">(</span><span class="va">old</span>, <span class="op">~</span> <span class="fu">add_six_to_something</span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>new_3 <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl</a></span><span class="op">(</span><span class="va">old</span>, <span class="op">~</span> <span class="op">(</span><span class="va">.</span> <span class="op">+</span> <span class="fl">6</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 4
    old new_1 new_2 new_3
  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1     4    10    10    10
2    16    22    22    22
3     9    15    15    15</code></pre>
</div>
</div>
<!-- DK: Explicitly show how rnorm() won't work with just mutate because you get the same answer. -->
<p>All three produce the same answer, as we would expect. Just using <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code> is best, as long as it accomplishes your goal. In complex situations, especially those involving simulation, it often won’t. Example:</p>
<div class="cell">

</div>
<div class="cell">
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>ID <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 2
     ID      x
  &lt;int&gt;  &lt;dbl&gt;
1     1 -0.282
2     2 -0.282
3     3 -0.282</code></pre>
</div>
</div>
<p>Calling <code><a href="https://rdrr.io/r/stats/Normal.html">rnorm()</a></code>, or any function with a random component, does not have the effect which you probably want if you do it in the context of a simple <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code>. Instead, R runs <code>rnorm(1)</code> once, and then copies the value generated to the remaining two rows of the tibble. To get a different value in each row, you need to explicitly tell R to do that by using a <code>map_*</code> function:</p>
<div class="cell">

</div>
<div class="cell">
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>ID <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>y <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl</a></span><span class="op">(</span><span class="va">ID</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 3
     ID      x      y
  &lt;int&gt;  &lt;dbl&gt;  &lt;dbl&gt;
1     1 -0.282 -1.31 
2     2 -0.282  0.795
3     3 -0.282  0.270</code></pre>
</div>
</div>
<p>Note that the parentheses in the anonymous function are not necessary. As long as everything after the <code>~</code> works as R code, the anonymous function should work, each time replacing the <code>.</code> with the value in the relevant row from the <code>.x</code> variable — which is <code>old</code> in this case.</p>
<div class="cell">
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>old <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">16</span>, <span class="fl">9</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>new <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl</a></span><span class="op">(</span><span class="va">old</span>, <span class="op">~</span> <span class="va">.</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 2
    old   new
  &lt;dbl&gt; &lt;dbl&gt;
1     4     5
2    16    17
3     9    10</code></pre>
</div>
</div>
</section><section id="skateboard-perfectly-formed-rear-view-mirror" class="level3"><h3 class="anchored" data-anchor-id="skateboard-perfectly-formed-rear-view-mirror">Skateboard &gt;&gt; perfectly formed rear-view mirror</h3>
<!-- DK: Cut this or explain it. Too confusing/useless for beginners. -->
<p>This image — widely attributed to the Spotify development team — conveys an important point.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="functions/images/mvp.jpg" class="img-fluid figure-img" style="width:60.0%"></p>
<p></p><figcaption class="figure-caption">From <a href="https://blog.fastmonkeys.com/2014/06/18/minimum-viable-product-your-ultimate-guide-to-mvp-great-examples/">Your ultimate guide to Minimum Viable Product (+great examples)</a></figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>Build that skateboard before you build the car or some fancy car part. A limited-but-functioning thing is very useful. It also keeps spirits high.</p>
<p>This is related to the Telescope Rule:</p>
<blockquote class="blockquote">
<p>It is faster to make a four-inch mirror and then a six-inch mirror than it is to make a six-inch mirror.</p>
</blockquote>
</section></section><section id="no_na_sampler" class="level2"><h2 class="anchored" data-anchor-id="no_na_sampler"><code>no_NA_sampler()</code></h2>
<p>Assume that we want to sample 10 observations for <code>height</code> from the <code>nhanes</code> tibble from the <strong>primer.data</strong> package. That is easy to do with the built in function <code><a href="https://rdrr.io/r/base/sample.html">sample()</a></code>.</p>
<div class="cell">
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">nhanes</span><span class="op">$</span><span class="va">height</span>, size <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] 159.4 119.3 170.5 171.1 180.9 135.7  99.3 168.7 152.6 175.0</code></pre>
</div>
</div>
<p>One problem with this approach is that it will sample missing values of <code>height</code>. We can avoid that by manipulating the vector inside of the call to <code><a href="https://rdrr.io/r/base/sample.html">sample()</a></code>.</p>
<div class="cell">
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">nhanes</span><span class="op">$</span><span class="va">height</span><span class="op">[</span><span class="op">!</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">nhanes</span><span class="op">$</span><span class="va">height</span><span class="op">)</span><span class="op">]</span>, size <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] 163.4 141.0 158.0 160.5 168.8 182.6 116.6 157.9  86.0 175.7</code></pre>
</div>
</div>
<p>That works, but, first, it is ugly code. And, second, it is hard to extend when we have more constraints. For example, assume we only want to sample from individuals who have no missing values for any variables, not just <code>height</code>. To do that, we really ought to make a custom function. Call that function <code>no_NA_sampler()</code>.</p>
<p>The first step in function creation is to write code in a normal pipe which does what you want the function to do. In this case, that code would look like:</p>
<div class="cell">
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">nhanes</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/drop_na.html">drop_na</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice_sample</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">10</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">height</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] 156.8 166.5 170.9 160.3 155.5 151.7 165.5 150.0 175.3 159.6</code></pre>
</div>
</div>
<p>We start with <code>nhanes</code>, use <code><a href="https://tidyr.tidyverse.org/reference/drop_na.html">drop_na()</a></code> to remove rows with missing values for any variable, sample 10 rows at random and then pull out <code>height</code>. To turn this into a function, we just need to copy/paste this pipe within the body of our function definition:</p>
<div class="cell">
<div class="sourceCode" id="cb66"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">no_NA_sampler</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">nhanes</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/drop_na.html">drop_na</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice_sample</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">10</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">height</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">no_NA_sampler</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] 162.4 165.2 159.0 155.5 159.0 160.3 157.2 170.7 164.4 155.9</code></pre>
</div>
</div>
<p>Voila! A function just executes the code within its body. <em>The first step in building a function is not to write the function. It is to write the code which you want the function to execute.</em></p>
<p>The first version, however, “hard codes” a lot of options which we might want to change. What if we want to sample 5 values of height or 500? In that case, we could hard code a new number in place of “10”. A better option would be to add an argument so that we can pass in whatever value we want.</p>
<div class="cell">
<div class="sourceCode" id="cb68"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">no_NA_sampler</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">nhanes</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/drop_na.html">drop_na</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice_sample</a></span><span class="op">(</span>n <span class="op">=</span> <span class="va">n</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">height</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">no_NA_sampler</span><span class="op">(</span>n <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 163.7 170.0</code></pre>
</div>
<div class="sourceCode" id="cb70"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">no_NA_sampler</span><span class="op">(</span>n <span class="op">=</span> <span class="fl">25</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] 156.0 171.6 166.5 168.4 166.0 163.7 163.6 161.0 159.0 156.5 163.4 163.7
[13] 168.1 170.3 154.8 176.6 173.2 166.1 169.4 173.4 174.2 156.8 159.3 157.0
[25] 159.0</code></pre>
</div>
</div>
<p>What if we want to sample from a different variable than <code>height</code> or from a different tibble than <code>nhanes</code>? Again, the trick is to turn hard coded values into arguments. The argument <code>tbl</code> is a placeholder for a data set, <code>n</code> for the number of samples you want extracted from your data set, and <code>var</code> for the variable in the samples that we are studying.</p>
<div class="cell">
<div class="sourceCode" id="cb72"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">no_NA_sampler</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">tbl</span>, <span class="va">var</span>, <span class="va">n</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">tbl</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/drop_na.html">drop_na</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice_sample</a></span><span class="op">(</span>n <span class="op">=</span> <span class="va">n</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="op">{</span><span class="op">{</span><span class="va">var</span><span class="op">}</span><span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">no_NA_sampler</span><span class="op">(</span>tbl <span class="op">=</span> <span class="va">nhanes</span>, var <span class="op">=</span> <span class="va">height</span>, n <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 163.6 163.4</code></pre>
</div>
</div>
<p>R does not know how to interpret something like <code>age</code> when it is passed in an argument. The double curly braces around <code>var</code> tell R, in essence, that <code>var</code> is a variable in the tibble created from sampling from our input tibble <code>tbl</code>. We can use the order of the arguments, without naming them, with <code>no_NA_sampler()</code>, just as with any other R function:</p>
<div class="cell">
<div class="sourceCode" id="cb74"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">no_NA_sampler</span><span class="op">(</span><span class="va">trains</span>, <span class="va">age</span>, <span class="fl">5</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 45 42 41 31 44</code></pre>
</div>
</div>
<!-- DK: I realize that the above is a lousy explanation. Feel free to change it completely. -->
<p>Now that we have the function doing what we want, we should add some comments and some error checking.</p>
<div class="cell">
<div class="sourceCode" id="cb76"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">no_NA_sampler</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">tbl</span>, <span class="va">var</span>, <span class="va">n</span><span class="op">)</span><span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># Function for grabbing `n` samples from a variable `var` which lives in a</span></span>
<span>  <span class="co"># tibble `tbl`. </span></span>
<span>  </span>
<span>  <span class="co"># I could not figure out how to check to see if `var` actually lives in the</span></span>
<span>  <span class="co"># tibble in my error checking. Also, I don't like that I need to use</span></span>
<span>  <span class="co"># is_double() as the check on `n` even though I want `n` to be an integer.</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html">stopifnot</a></span><span class="op">(</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/is_tibble.html">is_tibble</a></span><span class="op">(</span><span class="va">tbl</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html">stopifnot</a></span><span class="op">(</span><span class="fu"><a href="https://rlang.r-lib.org/reference/type-predicates.html">is_double</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">tbl</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/drop_na.html">drop_na</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    </span>
<span>    <span class="co"># What happens if n is "too large"? That is, I need to think harder about a)</span></span>
<span>    <span class="co"># whether or not I am sampling with or without replacement and b) which I</span></span>
<span>    <span class="co"># should be doing.</span></span>
<span>    </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice_sample</a></span><span class="op">(</span>n <span class="op">=</span> <span class="va">n</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="op">{</span><span class="op">{</span><span class="va">var</span><span class="op">}</span><span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Do the comments in the above code seem weird? Perhaps. But they are good comments! First, there about as many lines of comments as there are lines of code. That is a good rule of thumb. Second, the comments do not simple report what the code is doing. That is redundant! <em>The code itself tells us what the code is doing.</em> The comments, instead, are a discussion of issues related to the code, to things we don’t understand, to topics which we should revisit. They are like a diary. Good programmers keep good diaries.</p>
</section><section id="prediction-game" class="level2"><h2 class="anchored" data-anchor-id="prediction-game">Prediction Game</h2>
<p>Let’s play a prediction game. Consider the <code>kenya</code> tibble from <strong>primer.data</strong>.</p>
<div class="cell">
<div class="sourceCode" id="cb77"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">kenya</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1,672 × 9
   block    poll_station treatment poverty dista…¹ pop_d…² mean_…³ reg_b…⁴  rv13
   &lt;chr&gt;    &lt;chr&gt;        &lt;fct&gt;       &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;
 1 KWALE/42 007/001      control     0.247    22.0 2.96e-3    39.6 0.00358  1116
 2 KWALE/35 007/004      local + …   0.329    25.1 8.88e-4    43.8 0.0742    364
 3 KWALE/40 007/009      local       0.263    27.8 1.84e-3    34.7 0.00691  4632
 4 KWALE/18 007/011      local + …   0.429    27.2 2.70e-4    44.6 0.26      150
 5 KWALE/12 007/017      local + …   0.341    19.3 5.44e-4    39.0 0.0228    833
 6 KWALE/42 007/018      local       0.204    24.0 7.98e-3    37.1 0.00243  1646
 7 KWALE/40 007/019      SMS         0.272    25.1 1.67e-3    39.2 0.00487   616
 8 KWALE/12 007/020      control     0.316    23.8 5.38e-4    36.3 0         775
 9 KWALE/30 007/022      canvass     0.396    20.5 2.16e-4    42.9 0.00575   696
10 KWALE/16 007/023      local + …   0.398    14.5 1.48e-4    39.8 0.0360    722
# … with 1,662 more rows, and abbreviated variable names ¹​distance,
#   ²​pop_density, ³​mean_age, ⁴​reg_byrv13
# ℹ Use `print(n = ...)` to see more rows</code></pre>
</div>
</div>
<p>The game is that we will pick a random value of <code>rv13</code>, which is the number of people who live in the vicinity of a polling station. You guess a number. I guess a number. The winner of the Prediction Game is the person whose guess is closest to the random value selected. Example:</p>
<div class="cell">
<div class="sourceCode" id="cb79"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">your_guess</span> <span class="op">&lt;-</span> <span class="fl">500</span></span>
<span><span class="va">my_guess</span> <span class="op">&lt;-</span> <span class="fl">600</span></span>
<span></span>
<span><span class="va">sampled_value</span> <span class="op">&lt;-</span> <span class="fu">no_NA_sampler</span><span class="op">(</span><span class="va">kenya</span>, <span class="va">rv13</span>, n <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">your_error</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">your_guess</span> <span class="op">-</span> <span class="va">sampled_value</span><span class="op">)</span></span>
<span><span class="va">my_error</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">my_guess</span> <span class="op">-</span> <span class="va">sampled_value</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="va">your_error</span> <span class="op">&lt;</span> <span class="va">my_error</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"You win!"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>You win!</code></pre>
</div>
<div class="sourceCode" id="cb81"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw">if</span><span class="op">(</span><span class="va">your_error</span> <span class="op">&gt;</span> <span class="va">my_error</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"I win!"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Run this code in your R Console to try it out. It works! It is also sloppy and disorganized. <em>The first step in writing good code is to write bad code</em>.</p>
<p>We don’t want to play the Prediction Game just once. We want to play it thousands of times. Copy/pasting this code a thousand times would be stupid. Instead, we need a function. Just place the working code within a function definition, and Voila!</p>
<div class="cell">
<div class="sourceCode" id="cb82"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">prediction_game</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">your_guess</span> <span class="op">&lt;-</span> <span class="fl">500</span></span>
<span>  <span class="va">my_guess</span> <span class="op">&lt;-</span> <span class="fl">600</span></span>
<span>  </span>
<span>  <span class="va">sampled_value</span> <span class="op">&lt;-</span> <span class="fu">no_NA_sampler</span><span class="op">(</span><span class="va">kenya</span>, <span class="va">rv13</span>, n <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> </span>
<span>  </span>
<span>  <span class="va">your_error</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">your_guess</span> <span class="op">-</span> <span class="va">sampled_value</span><span class="op">)</span></span>
<span>  <span class="va">my_error</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">my_guess</span> <span class="op">-</span> <span class="va">sampled_value</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">your_error</span> <span class="op">&lt;</span> <span class="va">my_error</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"You win!"</span><span class="op">)</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">your_error</span> <span class="op">&gt;</span> <span class="va">my_error</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"I win!"</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Other than the function definition itself, there are no changes. Yet, by creating a function, we can now easily run this many times.</p>
<div class="cell">
<div class="sourceCode" id="cb83"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">replicate</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fu">prediction_game</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>You win!You win!You win!</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
NULL

[[2]]
NULL

[[3]]
NULL</code></pre>
</div>
</div>
<p>The problem with this version is that we want <code>prediction_game()</code> to <em>return</em> a message about the winner. Right now, it returns nothing. It just prints the winner. Let’s change that, and also allow for guesses to be passed in as an argument, along with the tibble and variable. We can leave <code>n</code> hard coded as 1 since, by definition, the Prediction Game is an attempt to guess one number, at least for now. To do this, we need to use the <code><a href="https://rdrr.io/r/base/function.html">return()</a></code> function which, when executed, causes the function to finish and return whatever value is within the paratheses.</p>
<!-- DK: Add some code comments, especially {{var}} -->
<div class="cell">
<div class="sourceCode" id="cb86"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">prediction_game</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">guesses</span>, <span class="va">tbl</span>, <span class="va">var</span><span class="op">)</span><span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># Check to make sure that guesses is a vector of doubles of length 2.</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html">stopifnot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/all.html">all</a></span><span class="op">(</span><span class="fu"><a href="https://rlang.r-lib.org/reference/type-predicates.html">is_double</a></span><span class="op">(</span><span class="va">guesses</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html">stopifnot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">guesses</span><span class="op">)</span> <span class="op">==</span> <span class="fl">2</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># This tells the function that the "guess" inputted first in the </span></span>
<span>  <span class="co"># guesses is "your" guess, whereas the second input is "my" guess.</span></span>
<span>  </span>
<span>  <span class="va">your_guess</span> <span class="op">&lt;-</span> <span class="va">guesses</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="va">my_guess</span> <span class="op">&lt;-</span> <span class="va">guesses</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="co"># Use the function no_NA_sampler to draw a sample from a data set</span></span>
<span>  <span class="co"># of our choosing, with a {{var}} and n.</span></span>
<span>  </span>
<span>  <span class="va">sampled_value</span> <span class="op">&lt;-</span> <span class="fu">no_NA_sampler</span><span class="op">(</span><span class="va">tbl</span>, <span class="op">{</span><span class="op">{</span><span class="va">var</span><span class="op">}</span><span class="op">}</span>, n <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> </span>
<span>  </span>
<span>  <span class="co"># Subtract the sampled value obtained from no_NA_sampler from </span></span>
<span>  <span class="co"># both of our guesses. </span></span>
<span>  </span>
<span>  <span class="va">your_error</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">your_guess</span> <span class="op">-</span> <span class="va">sampled_value</span><span class="op">)</span></span>
<span>  <span class="va">my_error</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">my_guess</span> <span class="op">-</span> <span class="va">sampled_value</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># If the difference between your guess and the sampled value is </span></span>
<span>  <span class="co"># less than the difference between my guess and the sampled value</span></span>
<span>  <span class="co"># (meaning that your guess was closer to the truth), the function</span></span>
<span>  <span class="co"># returns the message "Guess, your_guess, wins!".</span></span>
<span>  </span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">your_error</span> <span class="op">&lt;</span> <span class="va">my_error</span><span class="op">)</span><span class="op">{</span> </span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"Guess"</span>, <span class="va">your_guess</span>, <span class="st">"wins!"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># If your error exceeds my error (meaning that your guess was</span></span>
<span>  <span class="co"># further than the truth than mine), the function prints the </span></span>
<span>  <span class="co"># message "Guess, my_guess, wins!" </span></span>
<span>  </span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">your_error</span> <span class="op">&gt;</span> <span class="va">my_error</span><span class="op">)</span><span class="op">{</span> </span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"Guess"</span>, <span class="va">my_guess</span>, <span class="st">"wins!"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># If we guess the same number, and our error rates are therefore</span></span>
<span>  <span class="co"># identical, we return the message "A tie!". </span></span>
<span>  </span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">your_error</span> <span class="op">==</span> <span class="va">my_error</span><span class="op">)</span><span class="op">{</span> </span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="st">"A tie!"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb87"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">replicate</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fu">prediction_game</span><span class="op">(</span>guesses <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">500</span>, <span class="fl">600</span><span class="op">)</span>, <span class="va">kenya</span>, <span class="va">rv13</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Guess 500 wins!" "Guess 500 wins!" "Guess 600 wins!" "Guess 500 wins!"
[5] "Guess 500 wins!"</code></pre>
</div>
</div>
<p>In general, we will want to store the results in a tibble, which makes later analysis and plotting easier.</p>
<div class="cell">
<div class="sourceCode" id="cb89"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>ID <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>result <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_chr</a></span><span class="op">(</span><span class="va">ID</span>, <span class="op">~</span> </span>
<span>                            <span class="fu">prediction_game</span><span class="op">(</span>guesses <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">500</span>, <span class="fl">600</span><span class="op">)</span>,</span>
<span>                                            <span class="va">kenya</span>, </span>
<span>                                            <span class="va">rv13</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 2
     ID result         
  &lt;int&gt; &lt;chr&gt;          
1     1 Guess 500 wins!
2     2 Guess 500 wins!
3     3 Guess 500 wins!</code></pre>
</div>
</div>
<p>Who wins the game the most if we play 1,000 times?</p>
<div class="cell">

</div>
<div class="cell">
<div class="sourceCode" id="cb91"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>ID <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">1000</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>result <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_chr</a></span><span class="op">(</span><span class="va">ID</span>, <span class="op">~</span> </span>
<span>                            <span class="fu">prediction_game</span><span class="op">(</span>guesses <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">500</span>, <span class="fl">600</span><span class="op">)</span>,</span>
<span>                                            <span class="va">kenya</span>, </span>
<span>                                            <span class="va">rv13</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="functions_files/figure-html/unnamed-chunk-49-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>It is hardly surprising that 500 wins more often than 600 since the mean of <code>rv13</code> is 539.2332536. The mean seems like a pretty good guess! But it is not the best guess.</p>
<p>To test whether the mean or the median is a better guess, we will use our created <code>prediction_game</code> function with the guesses of 442 (the median) and 539 (the mean) and plot the results.</p>
<div class="cell">
<div class="sourceCode" id="cb92"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>ID <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">1000</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>result <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_chr</a></span><span class="op">(</span><span class="va">ID</span>, </span>
<span>                          <span class="op">~</span> <span class="fu">prediction_game</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">442</span>, <span class="fl">539</span><span class="op">)</span>,</span>
<span>                                            <span class="va">kenya</span>,</span>
<span>                                            <span class="va">rv13</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="functions_files/figure-html/unnamed-chunk-50-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>The mean is not a bad prediction. But the best prediction is (surprisingly?) the median, which is 442.</p>
<section id="playing-within-a-tibble" class="level4"><h4 class="anchored" data-anchor-id="playing-within-a-tibble">Playing within a tibble</h4>
<p>In other cases, it is more convenient to play portions of the Prediction Game within a tibble. Imagine that we are trying to guess the biggest value out of 10 random samples.</p>
<div class="cell">
<div class="sourceCode" id="cb93"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>ID <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, guess_1 <span class="op">=</span> <span class="fl">800</span>, guess_2 <span class="op">=</span> <span class="fl">900</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>result <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="va">ID</span>, <span class="op">~</span> <span class="fu">no_NA_sampler</span><span class="op">(</span><span class="va">kenya</span>, <span class="va">rv13</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 4
     ID guess_1 guess_2 result    
  &lt;int&gt;   &lt;dbl&gt;   &lt;dbl&gt; &lt;list&gt;    
1     1     800     900 &lt;dbl [10]&gt;
2     2     800     900 &lt;dbl [10]&gt;
3     3     800     900 &lt;dbl [10]&gt;</code></pre>
</div>
</div>
<p>We can now manipulate the <code>result</code> column and then see which prediction did better. Using the same structure as before, we subtract our guesses from the variable we were guessing; in this case, the biggest value in 10 random samples.</p>
<div class="cell">
<div class="sourceCode" id="cb95"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>ID <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, guess_1 <span class="op">=</span> <span class="fl">800</span>, guess_2 <span class="op">=</span> <span class="fl">900</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>result <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="va">ID</span>, <span class="op">~</span> <span class="fu">no_NA_sampler</span><span class="op">(</span><span class="va">kenya</span>, <span class="va">rv13</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>biggest <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl</a></span><span class="op">(</span><span class="va">result</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>error_1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">guess_1</span> <span class="op">-</span> <span class="va">biggest</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>error_2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">guess_2</span> <span class="op">-</span> <span class="va">biggest</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>winner <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span><span class="va">error_1</span> <span class="op">&lt;</span> <span class="va">error_2</span> <span class="op">~</span> <span class="st">"Guess one wins!"</span>,</span>
<span>                            <span class="va">error_1</span> <span class="op">&gt;</span> <span class="va">error_2</span> <span class="op">~</span> <span class="st">"Guess two wins!"</span>,</span>
<span>                            <span class="cn">TRUE</span> <span class="op">~</span> <span class="st">"A tie!"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 8
     ID guess_1 guess_2 result     biggest error_1 error_2 winner         
  &lt;int&gt;   &lt;dbl&gt;   &lt;dbl&gt; &lt;list&gt;       &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt; &lt;chr&gt;          
1     1     800     900 &lt;dbl [10]&gt;    1382     582     482 Guess two wins!
2     2     800     900 &lt;dbl [10]&gt;    2246    1446    1346 Guess two wins!
3     3     800     900 &lt;dbl [10]&gt;    1422     622     522 Guess two wins!</code></pre>
</div>
</div>
<p>Run the test 1,000 times.</p>
<div class="cell">
<div class="sourceCode" id="cb97"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>ID <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">1000</span>, guess_1 <span class="op">=</span> <span class="fl">800</span>, guess_2 <span class="op">=</span> <span class="fl">900</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>result <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="va">ID</span>, <span class="op">~</span> <span class="fu">no_NA_sampler</span><span class="op">(</span><span class="va">kenya</span>, <span class="va">rv13</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>biggest <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl</a></span><span class="op">(</span><span class="va">result</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>error_1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">guess_1</span> <span class="op">-</span> <span class="va">biggest</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>error_2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">guess_2</span> <span class="op">-</span> <span class="va">biggest</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>winner <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span><span class="va">error_1</span> <span class="op">&lt;</span> <span class="va">error_2</span> <span class="op">~</span> <span class="st">"Guess one wins!"</span>,</span>
<span>                            <span class="va">error_1</span> <span class="op">&gt;</span> <span class="va">error_2</span> <span class="op">~</span> <span class="st">"Guess two wins!"</span>,</span>
<span>                            <span class="cn">TRUE</span> <span class="op">~</span> <span class="st">"A tie!"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">winner</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="functions_files/figure-html/unnamed-chunk-53-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Empirically, we see than 900 is a much better guess than 800. Instead of calling a function to be run 1,000 times, we just performed each step within each row of a tibble with 1,000 rows. Both approaches work. The best choice depends on the context of your problem.</p>
</section></section><section id="summary" class="level2"><h2 class="anchored" data-anchor-id="summary">Summary</h2>
<p><em>The first step in writing good code is to write bad code</em>.</p>
<p><em>Tilde and dot (<code>~</code> and <code>.</code>) are easy to forget.</em></p>
<p><em>The first step in building a function is not to write the function. It is to write the code which you want the function to execute.</em></p>
<section id="lists-and-list-columns" class="level3"><h3 class="anchored" data-anchor-id="lists-and-list-columns">Lists and list-columns</h3>
<ul>
<li>A list is different from an atomic vector. Atomic vectors are familiar to us: each element of the vector has one value, and thus if an atomic vector is a column in your data set, each observation gets a single value. Lists, however, can contain vectors, and other more complex objects, as elements.</li>
<li>There are various ways to create lists. The most common is to use the <code><a href="https://rdrr.io/r/base/list.html">list()</a></code> function to “wrap” some object. <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> always returns a list.</li>
<li>We can take a list column and, by applying an anonymous function to it with <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code>, create another list column. This is similar to taking a tibble and piping it into a function, like <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code>, which returns a new tibble to work with.</li>
<li>You can also use <code>map_*</code> functions to take a list column as an input and return an atomic vector – a column with a single value per observation – as an output.</li>
</ul>
<p><em>If a function returns multiple values as a vector, you must use <code><a href="https://rdrr.io/r/base/list.html">list()</a></code> as a wrapper if you want to create a list-column.</em></p>
</section><section id="writing-functions" class="level3"><h3 class="anchored" data-anchor-id="writing-functions">Writing functions</h3>
<ul>
<li>Optimize usefulness by adding more formal arguments when needed. A function that only gives an option for <code>n</code> may not be as helpful as a function that allows us to enter options for a data set, variable, and n value.</li>
<li>Give your arguments sensible names.<br>
</li>
<li>By default, a function returns the result of the last line of the body. Use <code><a href="https://rdrr.io/r/base/function.html">return()</a></code> to override this default.</li>
<li>When starting a function, remember that smaller steps are easier than trying to build everything in one motion. In general: start by writing the body, test the body in a basic function, and then add formal arguments.<br>
</li>
<li>Use double curly braces around <code>var</code>s, since R does not know how to interpret variable names when they are passed in an argument. The double curly braces tell R that <code>var</code> is a variable in a tibble.</li>
</ul></section><section id="distributions" class="level3"><h3 class="anchored" data-anchor-id="distributions">Distributions</h3>
<ul>
<li>The word “distribution” can mean two things. First, it is an object — a mathematical formula, an imaginary urn — from which you can draw values. Second, it is a list of such values.<br>
</li>
<li>The two most important aspects of a distribution are its <em>center</em> and its <em>variability</em>.</li>
<li>The median is often a more stable measure of the center than the mean. The mad (scaled median absolute deviation) is often a more stable measure of variation than the standard deviation.</li>
<li>Outliers cause a lack a stability. In a distribution without outliers, the mean/median and mad/sd are so close in value that it does not matter much which ones you use.</li>
</ul>


</section></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      let href = ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./tools.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Tools</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./animation.html" class="pagination-link">
        <span class="nav-page-text">Animation</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>